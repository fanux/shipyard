## 插件式调度策略说明文档

## 系统架构
```
   +-------------------------+
   |      web dashboard      |
   +-------------------------+
             |        |                                 
             |        V                            
             |    +----------+
             |    | shipyard |          +------------+
  message    |    +----------+<-------->|            |
  bus        V                          |   swarm    |
  |  | pub+------------------+          |  cluster   |
  |  |<---| plugin manager   |<-------->|            |
  |  |    +----^-------------+          +------------+
  |  |         |
  |  | sub+----V------+
  |  |--->|  plugin   |
  |  |    +-----------+
```
* dashboard通过web界面对集群进行管理，如容器管理，镜像管理，节点管理，仓库管理，插件管理
* 除插件管理以外的功能通过复用开源软件shipyard实现
* plugin manager是一个单独的进程，扩展了shipyard的一些功能，主要是插件管理功能
* plugin是具体某个插件,也是单独的进程，通过http请求获取插件的信息以及获取策略文档
* 插件管理器通过消息总线主动通知插件一些事件，如插件策略有更新，插件被启用/禁用等

## 名词解释
* 插件 (plugin) 通过解析策略文档，决定怎样执行一个动作。包含一个唯一的插件名
* 策略 (strategy) 一个插件包含一个或多个插件策略，每个策略也包含一个唯一的策略名和一个策略文档（最为重要） 
* 策略文档 (strategy document) 特定策略的配置文档，在满足什么样的条件下做什么样的事情
* 手册 (manual) 怎么配置策略文档，各种字段含义是什么，配置事例等. 每个插件对应一个配置手册

对应关系：
    插件----策略1----策略文档1
          |-策略2----策略文档2
          |-策略3----策略文档3

不同的插件策略文档的格式不同，
同一个插件的不同策略文档格式相同，取值不同

## 设计目的，策略与执行分离
插件管理器不解析策略文档，各种各样的策略配置只有插件本身能够解析，解析完告诉管理器执行哪个动作即可

## 时间流插件 plugin_pipeline介绍

1. 在web界面上创建一个叫plugin_pipeline的插件，再创建一个策略叫scadule-hour-by-hour
2. 配置策略文档，内容如下：
```json
[
    {    
        "Cron":"* * 0 * * *",
        "Apps":[
            {
                "App":"ats",
                "Number":20
            },
            {
                "App":"hadoop:latest",
                "Number":10
            }
        ]
    },
    {    
        "Cron":"* * 1 * * *",
        "Apps":[
            {
                "App":"ats",
                "Number":10
            },
            {
                "App":"hadoop:latest",
                "Number":20
            }
        ]
    }
]
```
文档含义:
* Cron: 兼容linux crontab的配置格式，扩展了秒位。
```
*   5       *       *           *     *     ls             指定每小时的第5分钟执行一次ls命令
*   30     5       *           *     *     ls             指定每天的 5:30 执行ls命令
*   30     7       8         *     *     ls             指定每月8号的7：30分执行ls命令
*   30     5       8         6     *     ls             指定每年的6月8日5：30执行ls命令
*   30     6       *           *     0     ls             指定每星期日的6:30执行ls命令[注：0表示星期天，1表示星期1，
```
* 所以上面的文档含义为：0点的时候运行
